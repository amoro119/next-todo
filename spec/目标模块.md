# **“目标”功能产品需求文档 (PRD) - V1.2**

---

## **0.1 文档综述**

### **0.1.1 修订历史**

| 版本号 | 修订日期   | 修订人 | 修订内容                                                     |
| ------ | ---------- | ------ | ------------------------------------------------------------ |
| V1.0   | 2023-10-27 | 天才   | 创建初始文档                                                 |
| V1.1   | 2023-10-28 | 天才   | 根据用户反馈补充功能细节                                     |
| V1.2   | 2023-10-29 | 天才   | **[重大修订]** 优化创建流程、新增任务搜索、定义列表视图合并显示 |

### **0.1.2 项目背景**

当前版本的 `next-todo` 应用核心功能是待办事项（Todo）的管理，这对于处理日常的、独立性的任务非常高效。然而，当用户需要管理一个包含多个步骤、跨度时间较长的项目或计划时，单纯的待办事项列表就显得力不从心。用户难以将一系列相关的任务组织起来，也无法直观地追踪整个计划的宏观进度。

为了解决这一痛点，我们计划引入一个全新的“**目标 (Goals)**”功能。该功能旨在帮助用户设定、管理和追踪他们的长期规划，将宏大的目标分解为一系列具体的、可执行的待办事项，从而更清晰、更有条理地推进个人项目和人生规划。

### **0.1.3 功能概述**

“**目标**”是一个独立于“**待办事项**”的核心功能模块。一个“**目标**”代表一个长远的规划，它由一系列相关的“**待办事项**”组成。

本次项目将实现以下核心功能：
1.  **模式切换**：将应用主界面的“快捷操作按钮”改造为“**Todo模式**”与“**目标模式**”的切换入口。
2.  **目标的创建与管理**：用户可以在“**目标模式**”下创建、查看、编辑和存档目标。
3.  **目标与待办事项的关联**：建立目标与待办事项之间一对多的关联关系，支持在目标下创建任务，或为已有任务指定所属目标。
4.  **进度可视化**：在目标列表和详情页中，以百分比形式清晰展示目标的完成进度。
5.  **视图整合**：在“**Todo模式**”的待办事项列表中，将同属一个目标的任务进行**分组聚合显示**，帮助用户更好地聚焦于目标。

### **0.1.4 目标与成功指标**

**项目目标:**
* **提升用户规划能力**：为用户提供一个结构化的工具，帮助他们将长期计划分解为可执行的步骤。
* **增强产品核心价值**：从一个单纯的 Todo List 工具，升级为兼具日常任务管理和长期目标规划的综合性效率应用。
* **提高用户粘性**：通过引入深度规划功能，让用户将更重要、更长期的个人规划沉淀在产品中，从而提升用户的留存率和使用频率。

**成功指标:**
* **功能使用率**：“目标”功能上线后一个月内，**活跃用户中超过30%** 的用户创建过至少一个目标。
* **目标完成率**：所有被创建的目标中，**最终完成度达到100%并被存档的比例超过20%**。
* **用户满意度**：通过应用内问卷或反馈渠道收集用户评价，**功能满意度评分达到4.5分以上**（5分制）。

---

## **0.2 项目概览**

### **0.2.1 功能名称**
**目标 (Goals)**

### **0.2.2 需求描述**
为现有项目添加一个新的“**目标**”功能。目标是一系列长远的规划，由一系列不同时间的待办任务组成，是一个独立的数据模型。修改快捷操作按钮变为**Todo模式**和**目标模式**的切换按钮。切换到目标模式后，主界面变为“**新建目标**”和“**目标列表**”的入口。点击目标列表后进入目标详情页，展示为达成该目标所需的具体实施步骤。创建目标后，在Todo模式的待办事项列表下，同属一个目标的任务将合并显示。

### **0.2.3 项目范围**

**范围内 (In Scope):**
* “目标”数据模型的设计与实现，**确保与 ElectricSQL 同步机制兼容**。
* UI/UX 改造：快捷操作按钮 -> 模式切换按钮。
* “目标模式”下的主界面、目标列表页、目标详情页的开发。
* **流线型的创建/编辑目标弹窗**：在一个流程中完成目标信息填写和执行步骤（待办事项）的添加。
* 在添加执行步骤时，**支持搜索并关联已存在的待办任务**。
* 目标与待办事项的关联逻辑（一个待办事项只能属于一个目标）。
* 目标进度自动计算与展示。
* 目标的存档功能。
* 在 Todo 列表视图中，**将属于同一目标的任务聚合展示**。
* **确保所有功能在 Electron 桌面端表现一致**。

**范围外 (Out of Scope):**
* 不需要目标外的功能。

---

## **0.3 相关页面设计**

### **0.3.1 模式切换按钮 (原快捷操作按钮)**
* **位置**：原右下角“快捷操作”浮动按钮。
* **样式**：按钮图标会根据当前模式变化。
    * 在“**Todo模式**”下，图标可设计为靶心或旗帜，示意“切换到目标”。
    * 在“**目标模式**”下，图标可设计为列表或清单，示意“切换到待办事项”。
* **交互**：点击按钮，在“**Todo模式**”和“**目标模式**”之间进行切换，并伴有平滑的过渡动画。主界面的内容随之改变。

### **0.3.2 目标模式主界面**
* 当用户切换到“**目标模式**”后，原有的待办事项列表将替换为目标模式的主界面。
* **布局**：界面简洁，主要包含两个核心操作按钮。
    * **[+] 新建目标**：位于页面醒目位置，点击后弹出“新建/编辑目标”模态框。
    * **[☰] 目标列表**：点击后进入“目标列表”页面。

### **0.3.3 目标列表页**
* **布局**：采用卡片式列表，每个卡片代表一个目标。
* **排序**：默认按照用户设定的“**优先级**”降序排列，优先级相同的按创建时间倒序。
* **卡片内容**：
    * **目标名称**：加粗显示。
    * **进度条与百分比**：直观展示当前目标的完成进度。
    * **截止日期**：如用户已设置，则显示在名称下方，格式为 `截止于: YYYY-MM-DD`。临近或逾期的日期应有特殊颜色高亮。
* **交互**：点击任意目标卡片，进入该目标的“**目标详情页**”。
* **存档入口**：页面右上角提供一个“**已存档**”入口，点击可查看已存档的目标列表。

### **0.3.4 目标详情页**
* **头部区域**：
    * **目标名称**：大号字体展示。
    * **描述**：展示用户为目标添加的详细描述。
    * **起止日期**：如果设置了，则显示 `开始: YYYY-MM-DD` `结束: YYYY-MM-DD`。
    * **关联清单**：显示该目标关联的清单名称。
    * **进度条**：与列表页一致，展示总体进度。
    * **操作按钮**：右上角提供“**编辑**”和“**存档**”按钮。
* **内容区域 (待办事项列表)**：
    * **列表**：展示所有与此目标关联的待办事项。
    * **排序**：默认按创建顺序排序。支持用户通过**拖拽**方式手动调整任务的显示顺序。
    * **添加任务**：列表底部提供一个“**[+] 添加待办事项**”的按钮或输入框，可快速为当前目标创建新的任务。

### **0.3.5 新建/编辑目标弹窗 (流线型)**
这是一个多步骤的模态框（Modal），用于在一个流程中完成目标的创建/编辑和任务关联。
* **步骤一：填写目标基本信息**
    * **表单字段**：
        1.  **名称 (必填)**：文本输入框。
        2.  **关联清单 (可选)**：下拉选择框，数据源为用户已创建的清单列表。
        3.  **开始日期 (可选)**：日期选择器。
        4.  **截止日期 (可选)**：日期选择器。
        5.  **描述 (可选)**：多行文本输入区域。
        6.  **优先级 (可选)**：提供选项，如“高”、“中”、“低”。默认为“空”。
    * **操作按钮**：“**下一步：添加执行步骤**”和“**取消**”。
* **步骤二：添加执行步骤 (待办事项)**
    * **界面布局**：分为两个区域。
        1.  **添加新任务**：一个输入框，用于快速输入新的待办事项名称并添加。
        2.  **关联现有任务**：一个**搜索框**，用户可以输入关键词搜索已存在的、且未关联任何目标的待办事项，并将其勾选关联到当前目标。
    * **已关联任务列表**：下方实时显示已添加到该目标的任务列表。
    * **操作按钮**：“**完成**”和“**上一步**”。点击“**完成**”后，保存目标及其所有关联的任务。

### **0.3.6 Todo 列表视图 (带目标分组)**
* **位置**：在“**Todo模式**”下的主待办事项列表 (`TodoList.tsx`)。
* **显示逻辑**：
    * 当一个清单（或视图，如“今日”）下有多个待办事项**同属于一个目标**时，这些任务将被**聚合**到一个容器中。
    * **容器样式**：
        ```
        ### 📄 <目标名称> [点击切换]
        总计: <总任务数> 已完成: <已完成数> 进度: <百分比>      [查看全部 ->]
        ---
        > ⚪ <任务1标题> `优先级`
        > ...
        ```
    * **交互**：
        * 目标容器是展开的，不折叠。
---

## **0.4 用户旅程 (User Journey)**

### **0.4.1 创建新目标的旅程 (流线型)**
1.  **进入目标模式**：用户 `Alice` 打开应用，点击右下角的模式切换按钮，从“**Todo模式**”切换到“**目标模式**”。
2.  **开始创建**：`Alice` 在目标模式主界面点击“**新建目标**”按钮。
3.  **填写信息**：应用弹出“新建目标”模态框。`Alice` 填写了目标名称“**学习React Hooks**”，选择了关联清单“**学习**”，设定了截止日期，并添加了描述。她将优先级设为“**高**”。
4.  **添加执行步骤**：`Alice` 点击“**下一步**”，进入任务添加界面。
    * 她在“添加新任务”输入框中输入“**阅读useState文档**”并回车，该任务出现在下方的已关联列表中。
    * 她想起之前创建过一个任务“**完成React官方教程**”，于是在“搜索现有任务”框中输入“**教程**”，找到了该任务并勾选。该任务也加入了已关联列表。
5.  **完成创建**：`Alice` 点击“**完成**”。模态框关闭，目标和任务关联关系被保存。她被引导至“**目标列表**”页，新创建的目标出现在列表的最上方。

---

## **0.5 用户故事 (User Stories)**
* **As a 用户, I want to** 能够在一个流程中创建目标并为其添加新的或已有的待办事项，**so that** 我可以高效地完成计划的制定。
* **As a 用户, I want to** 在查看我的待办事项列表时，能看到属于同一个目标的任务被清晰地组织在一起，**so that** 我可以聚焦于完成某个特定目标下的任务。
* **As a 用户, I want to** 能够创建一个长期目标，并为其添加详细描述、起止日期和优先级，**so that** 我能清晰地规划未来。
* **As a 用户, I want to** 能够将多个待办任务关联到一个目标下，**so that** 我可以将大计划分解为可执行的小步骤。
* **As a 用户, I want to** 能在目标列表页直观地看到每个目标的进度和截止日期，**so that** 我可以快速了解我的整体规划进展。
* **As a 用户, I want to** 可以在目标详情页中手动拖拽排序待办事项，**so that** 我可以灵活安排任务的执行顺序。
* **As a 用户, I want to** 在完成一个目标（进度100%）后，可以将其存档，**so that** 我能专注于当前正在进行的目标。

---

## **0.6 实现逻辑**

### **0.6.1 数据模型设计 (Database Schema)**

**重要提示**：所有数据表的创建和修改都需要通过 **ElectricSQL 的迁移机制** 来执行，以确保本地数据库（PGlite）、桌面端（Electron）和远程PostgreSQL数据库的结构保持一致，并能被正确同步。

**`goals` 表 (新增)**
| 字段名 (Column) | 类型 (Type)             | 描述 (Description)                               |
| ----------------- | ----------------------- | ------------------------------------------------ |
| `id`              | `UUID` (Primary Key)    | 唯一标识符                                       |
| `name`            | `TEXT` (Not Null)       | 目标名称                                         |
| `description`     | `TEXT` (Nullable)       | 目标的详细描述                                   |
| `list_id`         | `UUID` (Nullable, FK to `lists.id`) | 关联的清单ID                                     |
| `start_date`      | `TIMESTAMPTZ` (Nullable)| 目标开始日期                                     |
| `due_date`        | `TIMESTAMPTZ` (Nullable)| 目标截止日期                                     |
| `priority`        | `INTEGER` (Not Null, Default: 0) | 优先级 (例如: 0-低, 1-中, 2-高)            |
| `created_time`      | `TIMESTAMPTZ` (Not Null, Default: NOW())| 创建时间                                         |
| `is_archived`     | `BOOLEAN` (Not Null, Default: false) | 是否已存档                                       |

**`todos` 表 (修改)**
| 字段名 (Column) | 类型 (Type)           | 描述 (Description)             |
| ----------------- | --------------------- | ------------------------------ |
| ... (原有字段)   | ...                   | ...                            |
| `goal_id`         | `UUID` (Nullable, FK to `goals.id`) | **[新增]** 关联的目标ID        |
| `sort_order_in_goal`   | `INTEGER` (Nullable)  | **[新增]** 在目标内的排序权重  |

### **0.6.2 核心功能逻辑**

* **Todo 列表分组**：
    * 在获取 `TodoList` 的数据源时，进行一次预处理。
    * 使用 `reduce` 或类似方法，将 `todos` 数组转换为一个新的数据结构，其中独立的任务和目标任务组并存。
    * 例如：`[{ type: 'todo', data: {...} }, { type: 'goal', name: '...', progress: 50, todos: [...] }]`
    * `TodoList` 组件根据 `type` 渲染不同的子组件。

* **任务搜索与关联**：
    * 在“新建/编辑目标”弹窗的步骤二中，提供一个搜索输入框。
    * 当用户输入时，向本地 PGlite 数据库发起查询，搜索 `todos` 表中 `title` 匹配且 `goal_id` 为 `NULL` 的记录。
    * 将搜索结果展示为带有多选框的列表，用户勾选后，在前端状态中将这些任务的 `goal_id` 标记为待更新。
    * 点击“完成”时，将这些待更新的 `goal_id` 批量写入数据库。

* **Electron 兼容性**：
    * 由于项目已采用 Local-First 架构，核心的数据逻辑都与本地 PGlite 交互。
    * 只要确保 Electron 的主进程 (`main.js`) 和渲染进程 (`preload.js`) 能够正确初始化和访问 PGlite 数据库，所有新功能天然就应该兼容。
    * 数据库 schema 的变更通过 ElectricSQL 迁移文件 (`db/migrations-client/index.ts`) 进行管理，Electron 启动时会加载并执行这些迁移，保证了数据结构的一致性。

---

## **0.7 功能描述 (Feature Description)**

### **0.7.1 “目标”数据模型**
* **`goals` 表**：如 **0.6.1** 所述，是目标功能的核心数据载体。
* **关联关系**：`goals` 与 `todos` 是一对多关系；`goals` 与 `lists` 是多对一关系。一个 `todo` 只能属于一个 `goal`。
* **数据同步**：`goals` 表和 `todos` 表的 `goal_id`、`sort_order_in_goal` 字段必须加入 ElectricSQL 的同步 Shape 定义中，以确保数据能在本地和远程之间正确同步。

### **0.7.2 模式切换 (Todo/目标)**
* 应用启动时，默认进入“**Todo模式**”。
* 模式切换按钮的状态和图标必须准确反映当前的应用模式。

### **0.7.3 创建与编辑目标 (流线型)**
* **创建流程**：
    * 用户在步骤一填写完目标信息并点击“下一步”后，目标数据暂存于前端状态中，**此时不写入数据库**。
    * 在步骤二，用户添加或关联的待办事项也暂存于前端状态。
    * 只有当用户在步骤二点击“**完成**”时，才将目标数据和所有待办事项的关联关系**一次性、原子性地**写入数据库（最好在一个事务中完成）。
* **编辑流程**：
    * 编辑时，弹窗直接进入步骤一，并预填充所有数据。
    * 进入步骤二时，加载并显示已关联的待办事项。

### **0.7.4 目标列表**
* **继承关联关系**：当一个目标关联了一个清单，那么在该目标下创建的所有待办事项，其 `list_id` 字段将自动继承该目标的 `list_id`。

### **0.7.5 目标详情**
* 详情页展示的数据必须与数据库实时同步。
* 待办事项列表的每一个任务卡片都应具备与主 `TodoList` 中任务卡片相同的基本操作。

### **0.7.6 目标与待办事项的关联**
* **方式一 (目标创建/编辑流程)**：在步骤二中，可以新建任务，也可以搜索并关联未分配目标的现有任务。
* **方式二 (Todo编辑弹窗)**：在 `TodoModal.tsx` 中新增一个“**所属目标**”的下拉选择字段。
    * 该下拉框数据源为所有**未存档**的目标列表。
    * 用户可以选择一个目标，或选择“**无**”来解除关联。

### **0.7.7 目标进度计算**
* 计算逻辑必须精确，分母不能为0（当一个目标下没有任何任务时，进度为0%）。
* 此计算逻辑建议封装为可复用的函数，在前端和（如果需要）后端都能调用。

### **0.7.8 目标存档**
* **定义**：目标没有独立的完成状态。当一个目标的进度达到100%时，用户可以选择将其“**存档**”。
* **操作**：存档是一个软删除操作，将 `goals` 表中对应记录的 `is_archived` 字段更新为 `true`。
* **影响**：
    * 已存档的目标将不再出现在主目标列表中。
    * 已存档的目标下的待办事项**保持不变**，不会被自动处理。
* **恢复**：用户应可以从存档列表中“**恢复**”一个目标，即将其 `is_archived` 字段设回 `false`。